import{r as n,j as u}from"../chunks/chunk-9a4f56c2.js";import{a as L,u as h,L as m,G as w,b as N,c as T,g as f,d as p,e as G,s as S,C as _,f as g,h as k,i as C,j as x}from"../chunks/chunk-a851f0d2.js";import{L as A}from"../chunks/chunk-2b26b7f1.js";const j=async(a,t)=>{const E=`/authenticate/${a}/${t}`;return await L.get(E,{withCredentials:!0})};function X(){const{setToken:a}=h(),[t,E]=n.useState(""),[r,O]=n.useState(""),[l,d]=n.useState(""),[I,o]=n.useState(m);return n.useEffect(()=>{const s=new URL(window.location.href).searchParams,c=s.get("code"),i=s.get("state"),e=s.get("error");E(c??""),O(i??""),d(e??""),console.log(c,i,e,"code, state, error")},[]),n.useEffect(()=>{l&&(window.opener=void 0,o(l===w?N:T),setTimeout(()=>{window.close()},1e3))},[l]),n.useEffect(()=>{const s=f(C),c=f(x),i=p().add(3,"day").toDate().toUTCString();if(console.log(t,s,r,s,"**************"),t&&s!==t&&c===r)o(G),j(t,r).then(async({data:e})=>{console.log(e,"data"),e!=null&&e.token&&(S(C,t,{expires:i}),localStorage.setItem(_,JSON.stringify(e.authkey)),a(e.token),o(g),window.opener[`${r}`](e.token),window.opener=void 0)}).catch(e=>{e.message!=="Request aborted"&&(console.error(e.message),o(T),setTimeout(()=>{window.close()},1e3))});else if(t&&t===s){const e=f(_);o(e?g:k)}},[t,a,r]),u.jsxs(u.Fragment,{children:[u.jsx("span",{children:I}),u.jsx(A,{href:"/blog",children:"返回首页"})]})}export{X as Page};
